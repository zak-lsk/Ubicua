<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISDOGAR - Seguridad</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="ventana">
        <h2>Seguridad</h2>
        <div class="contenido">
            <button onclick="enviarAccionAlarma('activar')">Activar Alarma</button>
            <button onclick="enviarAccionAlarma('desactivar')">Desactivar Alarma</button>
            <button onclick="location.href = 'index.html'">Volver</button>
        </div>
    </div>

    <div id="modalAlarma" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center;">
        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center;">
            <h2>⚠️ Movimiento Detectado</h2>
            <p>Tienes 30 segundos para responder.</p>
            <p id="contador">30 segundos</p>
            <button id="desactivarAlarma">Sí, soy yo</button>
            <button id="activarSonido">No soy yo</button>
        </div>
    </div>

    <script>
        window.onload = function () {
            fetch('/alarma', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'accion=verificar'
            })
            .then(response => response.json())
            .then(data => {
                if (data.alarmaActivada && data.movimientoDetectado) {
                    mostrarModal(); // Mostrar el modal automáticamente
                }
            })
            .catch(error => console.error('Error al cargar el estado de la alarma:', error));
        };
        
        function enviarAccionAlarma(accion) {
            fetch('/alarma', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'accion=' + accion
            })
            .then(response => response.json())
            .then(data => console.log(data))
            .catch(error => console.error('Error:', error));
        }

        function mostrarModal() {
            const modal = document.getElementById("modalAlarma");
            modal.style.display = "flex";

            let tiempoRestante = 30;
            const contador = document.getElementById("contador");
            const intervalo = setInterval(() => {
                tiempoRestante--;
                contador.textContent = `${tiempoRestante} segundos`;
                if (tiempoRestante <= 0) {
                    clearInterval(intervalo);
                    enviarAccionAlarma('sonar');
                    modal.style.display = "none";
                }
            }, 1000);

            document.getElementById("desactivarAlarma").onclick = () => {
                clearInterval(intervalo);
                enviarAccionAlarma('desactivar');
                modal.style.display = "none";
            };

            document.getElementById("activarSonido").onclick = () => {
                clearInterval(intervalo);
                enviarAccionAlarma('sonar');
                modal.style.display = "none";
            };
        }

        // Verificar estado periódicamente
        setInterval(() => {
            fetch('/alarma', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'accion=verificar'
            })
            .then(response => response.json())
            .then(data => {
                if (data.alarmaActivada && data.movimientoDetectado) {
                    window.location.href = "seguridad.html";
                }
            })
            .catch(error => console.error('Error:', error));
        }, 5000);
    </script>
</body>
</html>